{% comment %}
  Yearly repository stats charts.
  - all: one compact combined chart with avg+median and P25-P75 bands.
  - systems/security: conference-specific lines only, split into Stars and Forks charts.

  Required page variables:
    page.yearly_chart_area â€” 'all', 'systems', or 'security'
{% endcomment %}

<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>

<div id="repoChartCombinedWrap" style="width:100%; max-width:940px; margin:1.0em 0; display:none;">
  <canvas id="yearlyRepoCombinedChart" height="290"></canvas>
</div>
<div id="repoChartStarsWrap" style="width:100%; max-width:940px; margin:0.8em 0; display:none;">
  <canvas id="yearlyRepoStarsChart" height="220"></canvas>
</div>
<div id="repoChartForksWrap" style="width:100%; max-width:940px; margin:0.8em 0; display:none;">
  <canvas id="yearlyRepoForksChart" height="220"></canvas>
</div>

<script>
(function() {
  var AREA = '{{ page.yearly_chart_area | default: "all" }}';
  var repoStatsByConference = {{ site.data.repo_stats.by_conference | jsonify }};
  var confCategory = {
    {% for conf in site.data.artifacts_by_conference %}
    "{{ conf.name }}": "{{ conf.category }}"{% unless forloop.last %},{% endunless %}
    {% endfor %}
  };

  function mean(values) {
    if (!values || values.length === 0) return null;
    var sum = 0;
    for (var i = 0; i < values.length; i++) sum += values[i];
    return sum / values.length;
  }

  function percentile(values, p) {
    if (!values || values.length === 0) return null;
    var sorted = values.slice().sort(function(a, b) { return a - b; });
    if (sorted.length === 1) return sorted[0];
    var index = (sorted.length - 1) * p;
    var lower = Math.floor(index);
    var upper = Math.ceil(index);
    var weight = index - lower;
    if (upper === lower) return sorted[lower];
    return sorted[lower] * (1 - weight) + sorted[upper] * weight;
  }

  function toFixed1(v) {
    if (v === null || v === undefined) return null;
    return Math.round(v * 10) / 10;
  }

  function hslColor(idx, total, sat, light) {
    var hue = Math.round((idx * 360) / Math.max(total, 1));
    return 'hsl(' + hue + ', ' + sat + '%, ' + light + '%)';
  }

  function collectAreaConferenceValues() {
    var yearMap = {};
    var conferenceYearValues = {};

    for (var i = 0; i < repoStatsByConference.length; i++) {
      var conf = repoStatsByConference[i];
      var confName = conf.name;
      var category = confCategory[confName];
      if (AREA !== 'all' && category !== AREA) continue;

      if (!conferenceYearValues[confName]) conferenceYearValues[confName] = {};
      var years = conf.years || [];
      for (var j = 0; j < years.length; j++) {
        var yr = years[j];
        var year = Number(yr.year);
        var stars = Number(yr.avg_stars || 0);
        var forks = Number(yr.avg_forks || 0);

        if (!yearMap[year]) yearMap[year] = { stars: [], forks: [] };
        yearMap[year].stars.push(stars);
        yearMap[year].forks.push(forks);
        conferenceYearValues[confName][year] = { stars: stars, forks: forks };
      }
    }

    var labels = Object.keys(yearMap).map(Number).sort(function(a, b) { return a - b; });
    return { labels: labels, yearMap: yearMap, conferenceYearValues: conferenceYearValues };
  }

  function renderAllCombined(base, areaLabel) {
    var labels = base.labels;
    var avgStars = [], medStars = [], p25Stars = [], p75Stars = [];
    var avgForks = [], medForks = [], p25Forks = [], p75Forks = [];

    for (var i = 0; i < labels.length; i++) {
      var y = labels[i];
      var starsVals = base.yearMap[y].stars;
      var forksVals = base.yearMap[y].forks;
      avgStars.push(toFixed1(mean(starsVals)));
      medStars.push(toFixed1(percentile(starsVals, 0.5)));
      p25Stars.push(toFixed1(percentile(starsVals, 0.25)));
      p75Stars.push(toFixed1(percentile(starsVals, 0.75)));
      avgForks.push(toFixed1(mean(forksVals)));
      medForks.push(toFixed1(percentile(forksVals, 0.5)));
      p25Forks.push(toFixed1(percentile(forksVals, 0.25)));
      p75Forks.push(toFixed1(percentile(forksVals, 0.75)));
    }

    var starsBand = p75Stars.map(function(v, i) {
      return (v === null || p25Stars[i] === null) ? null : toFixed1(v - p25Stars[i]);
    });
    var forksBand = p75Forks.map(function(v, i) {
      return (v === null || p25Forks[i] === null) ? null : toFixed1(v - p25Forks[i]);
    });

    document.getElementById('repoChartCombinedWrap').style.display = '';

    new Chart(document.getElementById('yearlyRepoCombinedChart'), {
      type: 'line',
      data: {
        labels: labels,
        datasets: [
          { label: 'Stars P25 (hidden anchor)', data: p25Stars, yAxisID: 'yStars', borderColor: 'rgba(0,0,0,0)', backgroundColor: 'rgba(0,0,0,0)', pointRadius: 0, borderWidth: 0, fill: false },
          { label: 'Stars P25-P75', data: starsBand, yAxisID: 'yStars', borderColor: 'rgba(31,119,180,0)', backgroundColor: 'rgba(31,119,180,0.13)', pointRadius: 0, borderWidth: 0, fill: '-1' },
          { label: 'Avg Stars', data: avgStars, yAxisID: 'yStars', borderColor: 'rgba(31,119,180,1)', backgroundColor: 'rgba(31,119,180,1)', borderWidth: 2, pointRadius: 2.5, tension: 0.22, fill: false },
          { label: 'Median Stars', data: medStars, yAxisID: 'yStars', borderColor: 'rgba(31,119,180,0.9)', backgroundColor: 'rgba(31,119,180,0.9)', borderDash: [6,4], borderWidth: 2, pointRadius: 2, tension: 0.22, fill: false },
          { label: 'Forks P25 (hidden anchor)', data: p25Forks, yAxisID: 'yForks', borderColor: 'rgba(0,0,0,0)', backgroundColor: 'rgba(0,0,0,0)', pointRadius: 0, borderWidth: 0, fill: false },
          { label: 'Forks P25-P75', data: forksBand, yAxisID: 'yForks', borderColor: 'rgba(255,127,14,0)', backgroundColor: 'rgba(255,127,14,0.13)', pointRadius: 0, borderWidth: 0, fill: '-1' },
          { label: 'Avg Forks', data: avgForks, yAxisID: 'yForks', borderColor: 'rgba(255,127,14,1)', backgroundColor: 'rgba(255,127,14,1)', borderWidth: 2, pointRadius: 2.5, tension: 0.22, fill: false },
          { label: 'Median Forks', data: medForks, yAxisID: 'yForks', borderColor: 'rgba(255,127,14,0.9)', backgroundColor: 'rgba(255,127,14,0.9)', borderDash: [6,4], borderWidth: 2, pointRadius: 2, tension: 0.22, fill: false }
        ]
      },
      options: {
        responsive: true,
        interaction: { mode: 'index', intersect: false },
        plugins: {
          title: { display: true, text: areaLabel + ': Yearly Stars & Forks (Avg + Median with P25-P75 bands)' },
          legend: {
            labels: {
              filter: function(item) { return item.text.indexOf('(hidden anchor)') === -1; }
            }
          }
        },
        scales: {
          yStars: { type: 'linear', position: 'left', beginAtZero: true, title: { display: true, text: 'Stars (avg per repo)' } },
          yForks: { type: 'linear', position: 'right', beginAtZero: true, grid: { drawOnChartArea: false }, title: { display: true, text: 'Forks (avg per repo)' } },
          x: { title: { display: true, text: 'Year' } }
        }
      }
    });
  }

  function renderConferenceOnlySplit(base, areaLabel) {
    var labels = base.labels;
    var confNames = Object.keys(base.conferenceYearValues).sort();
    var starsDatasets = [];
    var forksDatasets = [];

    for (var i = 0; i < confNames.length; i++) {
      var conf = confNames[i];
      var starsData = [];
      var forksData = [];
      for (var j = 0; j < labels.length; j++) {
        var year = labels[j];
        var val = base.conferenceYearValues[conf][year];
        starsData.push(val ? toFixed1(val.stars) : null);
        forksData.push(val ? toFixed1(val.forks) : null);
      }

      starsDatasets.push({
        label: conf,
        data: starsData,
        borderColor: hslColor(i, confNames.length, 65, 40),
        backgroundColor: hslColor(i, confNames.length, 65, 40),
        borderWidth: 1.8,
        pointRadius: 2,
        tension: 0.2,
        fill: false
      });
      forksDatasets.push({
        label: conf,
        data: forksData,
        borderColor: hslColor(i, confNames.length, 65, 48),
        backgroundColor: hslColor(i, confNames.length, 65, 48),
        borderWidth: 1.8,
        pointRadius: 2,
        tension: 0.2,
        fill: false
      });
    }

    document.getElementById('repoChartStarsWrap').style.display = '';
    document.getElementById('repoChartForksWrap').style.display = '';

    new Chart(document.getElementById('yearlyRepoStarsChart'), {
      type: 'line',
      data: { labels: labels, datasets: starsDatasets },
      options: {
        responsive: true,
        interaction: { mode: 'index', intersect: false },
        plugins: { title: { display: true, text: areaLabel + ': Conference-specific Stars by Year' } },
        scales: {
          y: { beginAtZero: true, title: { display: true, text: 'Stars (avg per repo)' } },
          x: { title: { display: true, text: 'Year' } }
        }
      }
    });

    new Chart(document.getElementById('yearlyRepoForksChart'), {
      type: 'line',
      data: { labels: labels, datasets: forksDatasets },
      options: {
        responsive: true,
        interaction: { mode: 'index', intersect: false },
        plugins: { title: { display: true, text: areaLabel + ': Conference-specific Forks by Year' } },
        scales: {
          y: { beginAtZero: true, title: { display: true, text: 'Forks (avg per repo)' } },
          x: { title: { display: true, text: 'Year' } }
        }
      }
    });
  }

  var areaLabel = AREA === 'all' ? 'All Conferences' : AREA.charAt(0).toUpperCase() + AREA.slice(1);
  var base = collectAreaConferenceValues();

  if (AREA === 'all') renderAllCombined(base, areaLabel);
  else renderConferenceOnlySplit(base, areaLabel);
})();
</script>
