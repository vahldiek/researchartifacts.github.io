{% comment %}
  Dynamic institution ranking table loaded from JSON with sorting and pagination.
  Shows institutions ranked by combined_score (aggregated artifacts + AE committee memberships).

  Required page variables:
    page.institution_data_url  — path to the overall JSON file
    page.systems_data_url      — path to the systems JSON file
    page.security_data_url     — path to the security JSON file
{% endcomment %}

<div id="institution-controls" style="margin-bottom:6px; display:none; font-size:0.9em;">
  <label style="font-weight:bold; margin-right:4px; white-space:nowrap;">Area:</label>
  <select id="areaFilter" style="padding:2px 6px; font-size:0.95em;">
    <option value="all" selected>All Conferences</option>
    <option value="systems">Systems Only</option>
    <option value="security">Security Only</option>
  </select>
</div>

<div id="institution-legend" style="margin:0 0 6px 0; display:none; font-size:0.85em; color:#555;">
  Legend: I=Institution, C=Combined, R=Researchers, T=Artifacts, E=AE, H=Chaired, P=Papers, R%=Art. Rate, K=Conferences
</div>

<div id="institutionLoading"><em>Loading institution ranking data…</em></div>

<table id="institutionTable" style="display:none;">
<thead><tr id="institutionHead"></tr></thead>
<tbody id="institutionBody"></tbody>
</table>

<div id="institution-controls-bottom" style="margin-top:4px; display:none; font-size:0.9em;">
  <button id="iPrevBtnB" style="padding:2px 6px; font-size:0.9em;">&laquo; Prev</button>
  <span id="iPageInfoB" style="margin:0 6px;"></span>
  <button id="iNextBtnB" style="padding:2px 6px; font-size:0.9em;">Next &raquo;</button>
  <span id="iTotalInfo" style="margin-left:12px; color:#666;"></span>
</div>

<script>
(function() {
  var DATA_URLS = {
    'all': '{{ page.institution_data_url | relative_url }}',
    'systems': '{{ page.systems_data_url | relative_url }}',
    'security': '{{ page.security_data_url | relative_url }}'
  };
  var currentArea = 'all';
  var baseUrl = '{{ "" | relative_url }}';
  var allData = [];
  var sortedData = [];
  var yearColumns = [];
  var currentPage = 0;
  var pageSize = 100;
  var sortCol = 2; // default: Combined Score
  var sortAsc = false;
  var expandedRows = new Set(); // Track which rows are expanded
  var countryAbbrv = {};
  var countryReady = false;
  var countryLoadPromise = null;
  var countryInfoUrl = 'https://raw.githubusercontent.com/emeryberger/CSrankings/gh-pages/institutions.csv';

  var fixedCols = [
    {label:'#',                key:'rank',              type:'num'},
    {label:'I',                key:'affiliation',       type:'alpha'},
    {label:'C',                key:'combined_score',    type:'num'},
    {label:'R',                key:'num_authors',       type:'num'},
    {label:'T',                key:'artifacts',         type:'num'},
    {label:'E',                key:'ae_memberships',    type:'num'},
    {label:'H',                key:'chair_count',       type:'num'},
    {label:'P',                key:'total_papers',      type:'num'},
    {label:'R%',               key:'artifact_rate',     type:'num'},
    {label:'K',                key:'num_conferences',   type:'num'}
  ];

  function countryCodeToFlag(code) {
    if (!code || code.length !== 2) return '';
    var upper = code.toUpperCase();
    var first = String.fromCodePoint(0x1F1E6 + upper.charCodeAt(0) - 65);
    var second = String.fromCodePoint(0x1F1E6 + upper.charCodeAt(1) - 65);
    return first + second;
  }

  function normalizeInstKey(name) {
    return (name || '')
      .toLowerCase()
      .replace(/\buniv\.?\b/g, 'university')
      .replace(/\binst\.?\b/g, 'institute')
      .replace(/[()]/g, '')
      .replace(/[.,]/g, '')
      .replace(/\s-\s/g, ' ')
      .replace(/-/g, ' ')
      .replace(/\s+/g, ' ')
      .trim();
  }

  function parseCsvLine(line) {
    var out = [];
    var cur = '';
    var inQuotes = false;
    for (var i = 0; i < line.length; i++) {
      var ch = line[i];
      if (ch === '"') {
        if (inQuotes && line[i + 1] === '"') {
          cur += '"';
          i++;
        } else {
          inQuotes = !inQuotes;
        }
      } else if (ch === ',' && !inQuotes) {
        out.push(cur);
        cur = '';
      } else {
        cur += ch;
      }
    }
    out.push(cur);
    return out;
  }

  function loadCountryMap() {
    if (countryLoadPromise) return countryLoadPromise;
    countryLoadPromise = fetch(countryInfoUrl)
      .then(function(r) { return r.text(); })
      .then(function(text) {
        var lines = text.split(/\r?\n/);
        for (var i = 1; i < lines.length; i++) {
          var line = lines[i].trim();
          if (!line) continue;
          var parts = parseCsvLine(line);
          if (parts.length < 3) continue;
          var inst = parts[0];
          var code = parts[2];
          if (!inst || !code) continue;
          countryAbbrv[normalizeInstKey(inst)] = code;
        }
        countryReady = true;
      })
      .catch(function() {
        countryReady = false;
      });
    return countryLoadPromise;
  }

  function getFlagForInstitution(name) {
    if (!countryReady) return '';
    var code = countryAbbrv[normalizeInstKey(name)] || '';
    return code ? countryCodeToFlag(code) : '';
  }

  function render() {
    var start = pageSize > 0 ? currentPage * pageSize : 0;
    var end = pageSize > 0 ? start + pageSize : sortedData.length;
    var page = sortedData.slice(start, end);

    var tbody = document.getElementById('institutionBody');
    var rows = [];
    var numCols = fixedCols.length + yearColumns.length;
    
    for (var i = 0; i < page.length; i++) {
      var inst = page[i];
      var instId = 'inst-' + (start + i);
      var isExpanded = expandedRows.has(instId);
      var cells = [];
      
      // Rank column with expand button
      var expandIcon = inst.top_authors && inst.top_authors.length > 0 
        ? '<span class="expand-btn" style="cursor:pointer;margin-right:4px;">' + (isExpanded ? '▼' : '▶') + '</span>'
        : '<span style="margin-right:12px;"></span>';
      cells.push('<td>' + expandIcon + (start + i + 1) + '</td>');
      
      var aff = (inst.affiliation || 'Unknown').replace(/^_/, '');
      var flag = getFlagForInstitution(aff);
      cells.push('<td>' + (flag ? '<span aria-hidden="true">' + flag + '</span> ' : '') + escHtml(aff) + '</td>');
      cells.push('<td><strong>' + inst.combined_score + '</strong></td>');
      cells.push('<td>' + (inst.num_authors || '') + '</td>');
      cells.push('<td>' + (inst.artifacts || '') + '</td>');
      cells.push('<td>' + (inst.ae_memberships || '') + '</td>');
      var chairLabel = inst.chair_count > 0 ? inst.chair_count + ' \u2605' : '';
      cells.push('<td>' + chairLabel + '</td>');
      cells.push('<td>' + (inst.total_papers || '') + '</td>');
      cells.push('<td>' + (inst.total_papers > 0 ? inst.artifact_rate + '%' : '') + '</td>');
      cells.push('<td>' + (inst.conferences ? inst.conferences.length : '') + '</td>');
      for (var j = 0; j < yearColumns.length; j++) {
        var yr = yearColumns[j];
        var cnt = 0;
        if (inst.years) {
          cnt = inst.years[yr] || inst.years[String(yr)] || 0;
        }
        cells.push('<td>' + (cnt > 0 ? cnt : '') + '</td>');
      }
      
      rows.push('<tr class="inst-row" data-inst-id="' + instId + '" style="cursor:pointer;">' + cells.join('') + '</tr>');
      
      // Add expanded row if needed
      if (isExpanded && inst.top_authors && inst.top_authors.length > 0) {
        var expandedContent = '<td colspan="' + numCols + '" style="padding:8px 16px; background-color:#f9f9f9;">';
        expandedContent += '<div style="margin-left:20px;"><strong>Top ' + inst.top_authors.length + ' Researchers:</strong><br>';
        expandedContent += '<table style="margin-top:8px; font-size:0.9em; border-collapse:collapse; width:auto;">';
        expandedContent += '<thead><tr style="background-color:#e8e8e8;"><th style="padding:4px 8px;border:1px solid #ccc;">Name</th><th style="padding:4px 8px;border:1px solid #ccc;">Combined</th><th style="padding:4px 8px;border:1px solid #ccc;">Artifacts</th><th style="padding:4px 8px;border:1px solid #ccc;">AE Service</th><th style="padding:4px 8px;border:1px solid #ccc;">Papers</th></tr></thead><tbody>';
        
        for (var k = 0; k < inst.top_authors.length; k++) {
          var author = inst.top_authors[k];
          var displayName = author.name.replace(/\s+\d{4}$/, '').replace(/\t/g, ' ');
          var profileUrl = baseUrl + '/author.html?name=' + encodeURIComponent(author.name);
          expandedContent += '<tr style="' + (k % 2 === 0 ? 'background-color:#fff;' : 'background-color:#f5f5f5;') + '">';
          expandedContent += '<td style="padding:4px 8px;border:1px solid #ccc;"><a href="' + profileUrl + '">' + escHtml(displayName) + '</a></td>';
          expandedContent += '<td style="padding:4px 8px;border:1px solid #ccc;text-align:center;"><strong>' + author.combined_score + '</strong></td>';
          expandedContent += '<td style="padding:4px 8px;border:1px solid #ccc;text-align:center;">' + (author.artifacts || 0) + '</td>';
          expandedContent += '<td style="padding:4px 8px;border:1px solid #ccc;text-align:center;">' + (author.ae_memberships || 0) + '</td>';
          expandedContent += '<td style="padding:4px 8px;border:1px solid #ccc;text-align:center;">' + (author.total_papers || 0) + '</td>';
          expandedContent += '</tr>';
        }
        
        expandedContent += '</tbody></table></div></td>';
        rows.push('<tr class="expanded-row" data-inst-id="' + instId + '">' + expandedContent + '</tr>');
      }
    }
    tbody.innerHTML = rows.join('');
    
    // Add click handlers for expand/collapse
    var instRows = document.querySelectorAll('.inst-row');
    instRows.forEach(function(row) {
      row.addEventListener('click', function(e) {
        var instId = row.dataset.instId;
        if (expandedRows.has(instId)) {
          expandedRows.delete(instId);
        } else {
          expandedRows.add(instId);
        }
        render();
      });
    });
    
    updatePageInfo();
  }

  function escHtml(s) {
    var d = document.createElement('div');
    d.appendChild(document.createTextNode(s));
    return d.innerHTML;
  }

  function sortData(colIdx, asc) {
    var key;
    if (colIdx < fixedCols.length) {
      key = fixedCols[colIdx].key;
    } else {
      var yIdx = colIdx - fixedCols.length;
      var yr = yearColumns[yIdx];
      key = '_y' + yr;
    }
    sortedData.sort(function(a, b) {
      var av, bv;
      if (key.startsWith('_y')) {
        var y = key.slice(2);
        av = (a.years || {})[y] || (a.years || {})[parseInt(y)] || 0;
        bv = (b.years || {})[y] || (b.years || {})[parseInt(y)] || 0;
      } else if (key === 'affiliation') {
        av = (a[key] || '').toLowerCase();
        bv = (b[key] || '').toLowerCase();
      } else if (key === 'num_conferences') {
        av = a.conferences ? a.conferences.length : 0;
        bv = b.conferences ? b.conferences.length : 0;
      } else {
        av = a[key] || 0;
        bv = b[key] || 0;
      }
      if (av < bv) return asc ? -1 : 1;
      if (av > bv) return asc ? 1 : -1;
      return 0;
    });
  }

  function updatePageInfo() {
    var total = sortedData.length;
    var start = pageSize > 0 ? currentPage * pageSize : 0;
    var end = pageSize > 0 ? Math.min(start + pageSize, total) : total;
    var pages = pageSize > 0 ? Math.ceil(total / pageSize) : 1;
    var info = (start+1) + '–' + end + ' of ' + total;
    document.getElementById('iPageInfoB').textContent = info;
    document.getElementById('iTotalInfo').textContent = total + ' institutions total';
    var atFirst = currentPage <= 0;
    var atLast = pageSize <= 0 || currentPage >= pages - 1;
    document.getElementById('iPrevBtnB').disabled = atFirst;
    document.getElementById('iNextBtnB').disabled = atLast;
  }

  function buildHeader() {
    var tr = document.getElementById('institutionHead');
    tr.innerHTML = '';
    var allCols = fixedCols.slice();
    for (var i = 0; i < yearColumns.length; i++) {
      allCols.push({label: '' + yearColumns[i], key:'_y' + yearColumns[i], type:'num'});
    }
    for (var ci = 0; ci < allCols.length; ci++) {
      var th = document.createElement('th');
      th.innerHTML = allCols[ci].label;
      th.className = 'i-sortable';
      th.dataset.colIdx = ci;
      th.style.cursor = 'pointer';
      if (ci === sortCol) th.classList.add(sortAsc ? 'i-sorted-asc' : 'i-sorted-desc');
      th.addEventListener('click', (function(idx) {
        return function(e) {
          if (sortCol === idx) { sortAsc = !sortAsc; }
          else { sortCol = idx; sortAsc = false; }
          sortData(sortCol, sortAsc);
          currentPage = 0;
          render();
          var ths = document.getElementById('institutionHead').querySelectorAll('.i-sortable');
          ths.forEach(function(h) { h.classList.remove('i-sorted-asc','i-sorted-desc'); });
          e.currentTarget.classList.add(sortAsc ? 'i-sorted-asc' : 'i-sorted-desc');
        };
      })(ci));
      tr.appendChild(th);
    }
  }

  function init(data) {
    // Filter out institutions with Unknown affiliation
    allData = data.filter(function(inst) {
      var aff = (inst.affiliation || '').toLowerCase();
      return aff && aff !== 'unknown' && !aff.startsWith('_unknown');
    });
    sortedData = allData.slice();
    
    // Extract year columns
    var yrs = {};
    for (var i = 0; i < allData.length; i++) {
      if (allData[i].years) {
        for (var y in data[i].years) {
          yrs[y] = true;
        }
      }
    }
    yearColumns = Object.keys(yrs).map(function(y){ return parseInt(y) || y; })
      .sort(function(a,b){return b-a;});

    buildHeader();
    sortData(sortCol, sortAsc);
    render();
    loadCountryMap().then(function() { render(); });

    document.getElementById('institutionLoading').style.display = 'none';
    document.getElementById('institutionTable').style.display = '';
    document.getElementById('institution-controls').style.display = '';
    document.getElementById('institution-legend').style.display = '';
    document.getElementById('institution-controls-bottom').style.display = '';
  }

  function loadArea(area) {
    currentArea = area;
    expandedRows.clear(); // Clear expanded state when switching areas
    document.getElementById('institutionLoading').style.display = '';
    document.getElementById('institutionLoading').innerHTML = '<em>Loading ' + area + ' institution ranking data…</em>';
    document.getElementById('institutionTable').style.display = 'none';
    document.getElementById('institution-controls').style.display = 'none';
    document.getElementById('institution-legend').style.display = 'none';
    document.getElementById('institution-controls-bottom').style.display = 'none';
    
    fetch(DATA_URLS[area])
      .then(function(r) { return r.json(); })
      .then(init)
      .catch(function(e) {
        document.getElementById('institutionLoading').innerHTML =
          '<em>Failed to load ' + area + ' institution ranking data. ' + e + '</em>';
      });
  }

  // Area filter
  document.getElementById('areaFilter').addEventListener('change', function() {
    loadArea(this.value);
  });

  // Controls
  function goPrev() { if (currentPage > 0) { currentPage--; render(); } }
  function goNext() {
    var pages = pageSize > 0 ? Math.ceil(sortedData.length / pageSize) : 1;
    if (currentPage < pages - 1) { currentPage++; render(); }
  }
  document.getElementById('iPrevBtnB').addEventListener('click', goPrev);
  document.getElementById('iNextBtnB').addEventListener('click', goNext);

  // Load initial data
  loadArea(currentArea);
})();
</script>

<style>
#institutionTable { font-size: 0.78em; border-collapse: collapse; width: 100%; }
#institutionTable th, #institutionTable td { padding: 2px 4px; border: 1px solid #ddd; }
#institutionTable th:nth-child(2), #institutionTable td:nth-child(2) { max-width: 200px; word-wrap: break-word; white-space: normal; }
#institutionTable td { white-space: nowrap; }
#institutionTable th { background-color: #f2f2f2; position: sticky; top: 0; z-index: 1; }
#institutionTable tr:nth-child(even) { background-color: #f9f9f9; }
#institutionTable .inst-row:hover { background-color: #e8f4f8; }
#institutionTable .expanded-row { background-color: #f9f9f9 !important; }
#institutionTable .expanded-row:hover { background-color: #f9f9f9 !important; }
.i-sortable::after { content: '\2195'; opacity: 0.3; margin-left: 2px; font-size: 0.75em; }
.i-sorted-asc::after { content: '\2191'; opacity: 1; }
.i-sorted-desc::after { content: '\2193'; opacity: 1; }
.expand-btn { display: inline-block; font-size: 0.8em; color: #666; }
.expand-btn:hover { color: #000; }
</style>
