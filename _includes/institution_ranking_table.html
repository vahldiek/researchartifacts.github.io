{% comment %}
  Dynamic institution ranking table loaded from JSON with sorting and pagination.
  Shows institutions ranked by combined_score (aggregated artifacts + AE committee memberships).

  Required page variables:
    page.institution_data_url  — path to the overall JSON file
    page.systems_data_url      — path to the systems JSON file
    page.security_data_url     — path to the security JSON file
{% endcomment %}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flag-icons@7.0.0/css/flag-icons.min.css">

<div id="institution-controls" style="margin-bottom:6px; display:none; font-size:0.9em;">
  <label style="font-weight:bold; margin-right:4px; white-space:nowrap;">Area:</label>
  <select id="areaFilter" style="padding:2px 6px; font-size:0.95em;">
    <option value="all" selected>All Conferences</option>
    <option value="systems">Systems Only</option>
    <option value="security">Security Only</option>
  </select>
  <span style="margin:0 12px;"></span>
  <label style="font-weight:bold; margin-right:4px; white-space:nowrap;">Geo:</label>
  <select id="geoFilter" style="padding:2px 6px; font-size:0.95em;"></select>
  <span style="margin:0 12px;"></span>
  <label style="font-weight:bold; margin-right:4px; white-space:nowrap;">Search:</label>
  <input type="text" id="affiliationSearch" placeholder="Filter by institution name..." style="padding:2px 6px; font-size:0.95em; width:200px;">
</div>

<div id="institution-legend" style="margin:0 0 6px 0; display:none; font-size:0.85em; color:#555;">
  Legend: #=Rank, I=Institution, C=Combined, R=Researchers, Ar=Artifacts, P=Papers, AR%=Artifact Rate, RR%=Reproducibility Rate, AE=AE Service, Ch=Chaired
</div>

<div id="institutionLoading"><em>Loading institution ranking data…</em></div>

<table id="institutionTable" style="display:none;">
<thead><tr id="institutionHead"></tr></thead>
<tbody id="institutionBody"></tbody>
</table>

<div id="institution-controls-bottom" style="margin-top:4px; display:none; font-size:0.9em;">
  <button id="iPrevBtnB" style="padding:2px 6px; font-size:0.9em;">&laquo; Prev</button>
  <span id="iPageInfoB" style="margin:0 6px;"></span>
  <button id="iNextBtnB" style="padding:2px 6px; font-size:0.9em;">Next &raquo;</button>
  <span id="iTotalInfo" style="margin-left:12px; color:#666;"></span>
</div>

<script>
(function() {
  var DATA_URLS = {
    'all': '{{ page.institution_data_url | relative_url }}',
    'systems': '{{ page.systems_data_url | relative_url }}',
    'security': '{{ page.security_data_url | relative_url }}'
  };
  var currentArea = 'all';
  var baseUrl = '{{ "" | relative_url }}';
  var allData = [];
  var filteredData = [];
  var sortedData = [];
  var yearColumns = [];
  var currentPage = 0;
  var pageSize = 100;
  var sortCol = 2; // default: Combined Score
  var sortAsc = false;
  var expandedRows = new Set(); // Track which rows are expanded
  var searchFilter = ''; // Store current search filter
  var geoFilter = 'world';

  var fixedCols = [
    {label:'#',                key:'rank',              type:'num',   tip:'Rank'},
    {label:'I',                key:'affiliation',       type:'alpha', tip:'Institution'},
    {label:'C',                key:'combined_score',    type:'num',   tip:'Combined score'},
    {label:'R',                key:'num_authors',       type:'num',   tip:'Researchers'},
    {label:'Ar',               key:'artifacts',         type:'num',   tip:'Total artifacts'},
    {label:'P',                key:'total_papers',      type:'num',   tip:'Total papers'},
    {label:'AR%',              key:'artifact_rate',     type:'num',   tip:'Artifact rate: % papers with artifact'},
    {label:'RR%',              key:'repro_rate',        type:'num',   tip:'Reproducibility rate: % artifacts Reproduced'},
    {label:'AE',               key:'ae_memberships',    type:'num',   tip:'AE memberships'},
    {label:'Ch',               key:'chair_count',       type:'num',   tip:'Times chaired (★)'}
  ];

  // Country code to flag HTML (using flag-icons CSS library)
  function countryCodeToFlagHtml(code) {
    if (!code || code.length !== 2) return '';
    return '<span class="fi fi-' + code.toLowerCase() + '" title="' + code + '" style="margin-right:4px;"></span>';
  }

  // Country name to code mapping (comprehensive)
  var countryNameToCode = {
    'united states': 'US', 'usa': 'US', 'america': 'US', 'u.s.': 'US',
    'china': 'CN', 'peoples republic of china': 'CN', 'prc': 'CN', 'chinese': 'CN',
    'japan': 'JP', 'japan': 'JP', 
    'united kingdom': 'GB', 'uk': 'GB', 'britain': 'GB', 'british': 'GB',
    'germany': 'DE', 'deutsche': 'DE',
    'france': 'FR', 'french': 'FR',
    'canada': 'CA', 'canadian': 'CA',
    'australia': 'AU', 'australian': 'AU',
    'india': 'IN', 'indian': 'IN',
    'singapore': 'SG', 'singaporean': 'SG',
    'south korea': 'KR', 'korea': 'KR', 'korean': 'KR', 'republic of korea': 'KR',
    'switzerland': 'CH', 'swiss': 'CH', 'schweiz': 'CH',
    'netherlands': 'NL', 'dutch': 'NL', 'nl': 'NL',
    'sweden': 'SE', 'swedish': 'SE', 'sverige': 'SE',
    'norway': 'NO', 'norwegian': 'NO', 'norge': 'NO',
    'denmark': 'DK', 'danish': 'DK', 'danmark': 'DK',
    'finland': 'FI', 'finnish': 'FI', 'suomi': 'FI',
    'belgium': 'BE', 'belgian': 'BE', 'belgium': 'BE',
    'austria': 'AT', 'austrian': 'AT', 'österreich': 'AT',
    'israel': 'IL', 'israeli': 'IL',
    'italy': 'IT', 'italian': 'IT', 'italia': 'IT',
    'spain': 'ES', 'spanish': 'ES', 'españa': 'ES',
    'portugal': 'PT', 'portuguese': 'PT',
    'greece': 'GR', 'greek': 'GR', 'hellas': 'GR',
    'hong kong': 'HK', 'hk': 'HK',
    'taiwan': 'TW', 'taiwanese': 'TW', 'roc': 'TW',
    'thailand': 'TH', 'thai': 'TH',
    'brazil': 'BR', 'brazilian': 'BR', 'brasil': 'BR',
    'mexico': 'MX', 'mexican': 'MX', 'méxico': 'MX',
    'argentina': 'AR', 'argentine': 'AR',
    'chile': 'CL', 'chilean': 'CL',
    'ireland': 'IE', 'irish': 'IE', 'éire': 'IE',
    'new zealand': 'NZ', 'nz': 'NZ', 'aotearoa': 'NZ',
    'south africa': 'ZA',
    'russia': 'RU', 'russian': 'RU', 'soviet': 'RU',
    'ukraine': 'UA', 'ukrainian': 'UA',
    'poland': 'PL', 'polish': 'PL',
    'romania': 'RO', 'romanian': 'RO',
    'czechia': 'CZ', 'czech republic': 'CZ', 'cz': 'CZ',
    'hungary': 'HU', 'hungarian': 'HU', 'magyarország': 'HU',
    'turkey': 'TR', 'turkish': 'TR', 'türkiye': 'TR',
    'pakistan': 'PK', 'pakistani': 'PK',
    'malaysia': 'MY', 'malaysian': 'MY',
    'indonesia': 'ID', 'indonesian': 'ID',
    'vietnam': 'VN', 'vietnamese': 'VN',
    'philippines': 'PH', 'philippine': 'PH',
    'bangladesh': 'BD', 'bangladeshi': 'BD',
    'sri lanka': 'LK', 'ceylon': 'LK',
    'iran': 'IR', 'iranian': 'IR', 'persia': 'IR',
    'saudi arabia': 'SA', 'saudi': 'SA',
    'uae': 'AE', 'emirates': 'AE', 'united arab emirates': 'AE',
    'egypt': 'EG', 'egyptian': 'EG',
    'kenya': 'KE', 'kenyan': 'KE',
    'nigeria': 'NG', 'nigerian': 'NG',
    'morocco': 'MA', 'moroccan': 'MA',
    'colombia': 'CO', 'colombian': 'CO',
    'peru': 'PE', 'peruvian': 'PE',
    'venezuela': 'VE', 'venezuelan': 'VE'
  };

  var codeToName = {
    'US':'United States','CN':'China','JP':'Japan','GB':'United Kingdom',
    'DE':'Germany','FR':'France','CA':'Canada','AU':'Australia','IN':'India',
    'SG':'Singapore','KR':'South Korea','CH':'Switzerland','NL':'Netherlands',
    'SE':'Sweden','NO':'Norway','DK':'Denmark','FI':'Finland','BE':'Belgium',
    'AT':'Austria','IL':'Israel','IT':'Italy','ES':'Spain','PT':'Portugal',
    'GR':'Greece','HK':'Hong Kong','TW':'Taiwan','TH':'Thailand','BR':'Brazil',
    'MX':'Mexico','AR':'Argentina','CL':'Chile','IE':'Ireland','NZ':'New Zealand',
    'ZA':'South Africa','RU':'Russia','UA':'Ukraine','PL':'Poland','RO':'Romania',
    'CZ':'Czechia','HU':'Hungary','TR':'Turkey','PK':'Pakistan','MY':'Malaysia',
    'ID':'Indonesia','VN':'Vietnam','PH':'Philippines','BD':'Bangladesh',
    'LK':'Sri Lanka','IR':'Iran','SA':'Saudi Arabia','AE':'UAE','EG':'Egypt',
    'KE':'Kenya','NG':'Nigeria','MA':'Morocco','CO':'Colombia','PE':'Peru',
    'VE':'Venezuela'
  };

  var codeToContinent = {
    'US':'North America','CA':'North America','MX':'North America',
    'CN':'Asia','JP':'Asia','KR':'Asia','SG':'Asia','IN':'Asia','TW':'Asia',
    'HK':'Asia','TH':'Asia','PK':'Asia','MY':'Asia','ID':'Asia','VN':'Asia',
    'PH':'Asia','BD':'Asia','LK':'Asia','IR':'Asia','SA':'Asia','AE':'Asia',
    'GB':'Europe','DE':'Europe','FR':'Europe','CH':'Europe','NL':'Europe',
    'SE':'Europe','NO':'Europe','DK':'Europe','FI':'Europe','BE':'Europe',
    'AT':'Europe','IL':'Europe','IT':'Europe','ES':'Europe','PT':'Europe',
    'GR':'Europe','IE':'Europe','RU':'Europe','UA':'Europe','PL':'Europe',
    'RO':'Europe','CZ':'Europe','HU':'Europe','TR':'Europe',
    'AU':'Oceania','NZ':'Oceania',
    'BR':'South America','AR':'South America','CL':'South America',
    'CO':'South America','PE':'South America','VE':'South America',
    'ZA':'Africa','KE':'Africa','NG':'Africa','MA':'Africa','EG':'Africa'
  };

  // Extract country code from institution name
  function getCountryCodeFromName(name) {
    if (!name) return '';
    var lower = name.toLowerCase();
    
    // Known institutions and companies by country
    var knownInstitutions = {
      'mit': 'US', 'massachusetts institute': 'US', 'mass inst of tech': 'US',
      'university of massachusetts': 'US', 'umass': 'US', 'massachusetts': 'US',
      'stanford': 'US', 'berkeley': 'US', 'carnegie mellon': 'US',
      'harvard': 'US', 'princeton': 'US', 'yale': 'US', 'cornell': 'US',
      'columbia': 'US', 'penn': 'US', 'upenn': 'US', 'cmu': 'US',
      'ucsd': 'US', 'ucsb': 'US', 'ucla': 'US', 'uiuc': 'US',
      'uc san diego': 'US', 'uc berkeley': 'US', 'uc santa barbara': 'US', 'uc davis': 'US',
      'uc irvine': 'US', 'uc riverside': 'US', 'uc santa cruz': 'US', 'uc merced': 'US',
      'university of california': 'US',
      'georgia tech': 'US', 'msu': 'US', 'uofm': 'US', 'michigan': 'US',
      'caltech': 'US', 'purdue': 'US', 'texas austin': 'US', 'wisconsin': 'US',
      'washington state': 'US', 'washington': 'US', 'utexas': 'US',
      'virginia tech': 'US', 'stony brook': 'US', 'utah': 'US', 'uiuc': 'US',
      'duke': 'US', 'ohio state': 'US', 'illinois': 'US', 'penn state': 'US',
      'rice': 'US', 'northwestern': 'US', 'nyu': 'US', 'boston': 'US',
      'university of chicago': 'US', 'johns hopkins': 'US', 'brown university': 'US',
      'george mason': 'US', 'northeastern university': 'US', 'syracuse university': 'US',
      'stevens institute of technology': 'US', 'binghamton university': 'US',
      'emory university': 'US', 'university at buffalo': 'US', 'rutgers university': 'US',
      'william & mary': 'US', 'dartmouth college': 'US', 'case western reserve university': 'US',
      'sandia national laboratories': 'US', 'palo alto networks': 'US', 'netflix': 'US',
      'akamai technologies': 'US', 'tor project': 'US', 'trail of bits': 'US',
      'independent researcher': 'US', 'brave': 'US', 'feldera': 'US',
      'georgia': 'US',
      'microsoft research': 'US', 'microsoft research asia': 'CN', 'msra': 'CN',
      'google': 'US', 'microsoft': 'US', 'amazon': 'US', 'apple': 'US',
      'meta': 'US', 'facebook': 'US', 'ibm': 'US', 'intel': 'US',
      'cisco': 'US', 'oracle': 'US', 'vmware': 'US', 'adobe': 'US',
      
      // UK institutions
      'oxford': 'GB', 'cambridge': 'GB', 'imperial college': 'GB',
      'ucl': 'GB', 'london': 'GB', 'edinburgh': 'GB', 'manchester': 'GB',
      'bristol': 'GB', 'warwick': 'GB',
      
      // Europe
      'eth': 'CH', 'ethz': 'CH', 'zurich': 'CH', 'epfl': 'CH',
      'delft': 'NL', 'tu delft': 'NL', 'amsterdam': 'NL',
      'lund': 'SE', 'kth': 'SE', 'göteborg': 'SE', 'chalmers': 'SE',
      'oslo': 'NO', 'ntnu': 'NO',
      'aarhus': 'DK', 'copenhagen': 'DK',
      'helsinki': 'FI', 'aalto': 'FI', 'turku': 'FI',
      'leuven': 'BE', 'imec': 'BE', 'gent': 'BE',
      'vienna': 'AT', 'graz': 'AT', 'tu graz': 'AT', 'graz university of technology': 'AT', 'aachen': 'DE', 'tu aachen': 'DE',
      'rwth': 'DE', 'munich': 'DE', 'bonn': 'DE', 'heidelberg': 'DE',
      'berlin': 'DE', 'darmstadt': 'DE', 'karlsruhe': 'DE',
      'ruhr university bochum': 'DE', 'hasso plattner institute': 'DE', 'paderborn university': 'DE',
      'dresden university of technology': 'DE', 'technische universität braunschweig': 'DE', 'tu braunschweig': 'DE',
      'leibniz supercomputing center': 'DE', 'max-planck-institut für informatik': 'DE',
      'saarland': 'DE', 'tu darmstadt': 'DE',
        'max planck institute': 'DE', 'mpi-sws': 'DE', 'mpi-sp': 'DE', 'mpi': 'DE',
      'tu wien': 'AT', 'university of innsbruck': 'AT',
      'university of twente': 'NL',
      'royal holloway': 'GB', 'pqshield': 'GB',
      'masaryk university': 'CZ',
      'university of padua': 'IT', 'university of trento': 'IT',
      'universit catholique de louvain': 'BE', 'distrinet': 'BE',
      'laas-cnrs': 'FR',
      'university of lisbon': 'PT',
      'paris': 'FR', 'sorbonne': 'FR', 'inria': 'FR',
      'grenoble': 'FR', 'polytechnique': 'FR',
      'sapienza': 'IT', 'milano': 'IT', 'politecnico': 'IT', 'rome': 'IT',
      'valencia': 'ES', 'uc3m': 'ES', 'barcelona': 'ES', 'imdea software institute': 'ES',
      'universidade do porto': 'PT', 'técnico': 'PT', 'inesc': 'PT',
      'athens': 'GR', 'patras': 'GR', 'iacs-forth': 'GR',
      'prague': 'CZ', 'cuni': 'CZ', 'brno': 'CZ',
      'budapest': 'HU', 'warsaw': 'PL', 'krakow': 'PL',
      'bucharest': 'RO', 'moscow': 'RU', 'st petersburg': 'RU',
      'tech istanbul': 'TR', 'istanbul': 'TR',
      'tel aviv': 'IL', 'hebrew': 'IL', 'technion': 'IL',
      'weizmann': 'IL',
      
      // Asia
      'tsinghua': 'CN', 'peking': 'CN', 'fudan': 'CN', 'shanghai': 'CN',
      'jiao tong': 'CN',
      'huazhong university of science and technology': 'CN',
      'wuhan university': 'CN', 'beihang university': 'CN', 'shandong university': 'CN',
      'nankai university': 'CN', 'southeast university': 'CN', 'zhengzhou university': 'CN',
      'hunan university': 'CN', 'sun yat-sen university': 'CN',
      'national university of defense technology': 'CN',
      'institute of software': 'CN', 'institute of information engineering': 'CN',
      'zhongguancun laboratory': 'CN', 'ant group': 'CN',
      'zhejiang': 'CN', 'nanjing': 'CN', 'harbin': 'CN', 'beijing': 'CN',
      'alibaba': 'CN', 'tencent': 'CN', 'bytedance': 'CN', 'baidu': 'CN',
      'huawei': 'CN',
      'cispa': 'DE', 'saarland': 'DE',
      'ntu': 'TW', 'nthu': 'TW', 'nctu': 'TW',
      'academia sinica': 'TW',
      'hkust': 'HK', 'hku': 'HK', 'cuhk': 'HK', 'chinese university': 'HK',
      'tokyo': 'JP', 'kyoto': 'JP', 'osaka': 'JP', 'tohoku': 'JP',
      'kaist': 'KR', 'kaust': 'SA', 'seoul': 'KR', 'postech': 'KR',
      'nus': 'SG', 'ntu singapore': 'SG', 'nanyang technological university': 'SG', 'sutd': 'SG',
      'iisc': 'IN', 'iit bombay': 'IN', 'iit delhi': 'IN', 'iit kanpur': 'IN',
      'iit madras': 'IN', 'delhi': 'IN', 'mumbai': 'IN',
      'chula': 'TH', 'bangkok': 'TH',
      
      // Australia
      'sydney': 'AU', 'unsw': 'AU', 'melbourne': 'AU', 'monash': 'AU',
      'anu': 'AU', 'uwa': 'AU', 'uq': 'AU', 'adelaide': 'AU',
      'university of new south wales': 'AU', 'university of newcastle': 'AU', 'csiro marsfield': 'AU',
      
      // North America
      'toronto': 'CA', 'british columbia': 'CA', 'mcmaster': 'CA',
      'waterloo': 'CA', 'mcgill': 'CA', 'quebec': 'CA', 'calgary': 'CA',
      
      // South America
      'campinas': 'BR', 'são paulo': 'BR', 'usp': 'BR',
      'puc': 'BR', 'coppe': 'BR', 'ufmg': 'BR',
      'pontifical catholic university of minas gerais': 'BR',
      'mexico city': 'MX', 'unam': 'MX',
      'buenos aires': 'AR', 'uba': 'AR',
      'santiago': 'CL'
    };
    
    for (var inst in knownInstitutions) {
      if (lower.indexOf(inst) !== -1) {
        return knownInstitutions[inst];
      }
    }
    
    // Check for explicit country mentions
    for (var country in countryNameToCode) {
      if (lower.indexOf(country) !== -1) {
        return countryNameToCode[country];
      }
    }
    
    // Common US state indicators
    if (lower.match(/\b(alabama|alaska|arizona|arkansas|california|colorado|connecticut|delaware|florida|georgia|hawaii|idaho|illinois|indiana|iowa|kansas|kentucky|louisiana|maine|maryland|massachusetts|michigan|minnesota|mississippi|missouri|montana|nebraska|nevada|new hampshire|new jersey|new mexico|new york|north carolina|north dakota|ohio|oklahoma|oregon|pennsylvania|rhode island|south carolina|south dakota|tennessee|texas|utah|vermont|virginia|washington|west virginia|wisconsin|wyoming)\b/)) {
      return 'US';
    }
    
    // Common UK patterns
    if (lower.match(/\b(london|oxford|cambridge|edinburgh|manchester|bristol|imperial)\b/)) {
      return 'GB';
    }
    
    // Common city patterns by country  
    var cityCountryMap = {
      'paris': 'FR', 'munich': 'DE', 'berlin': 'DE', 'zurich': 'CH', 'geneva': 'CH',
      'amsterdam': 'NL', 'stockholm': 'SE', 'oslo': 'NO', 'copenhagen': 'DK',
      'tokyo': 'JP', 'beijing': 'CN', 'shanghai': 'CN', 'hong kong': 'HK',
      'singapore': 'SG', 'toronto': 'CA', 'melbourne': 'AU', 'sydney': 'AU',
      'delhi': 'IN', 'mumbai': 'IN', 'vancouver': 'CA',
      'são paulo': 'BR', 'buenos aires': 'AR',
      'tel aviv': 'IL', 'prague': 'CZ', 'budapest': 'HU', 'warsaw': 'PL'
    };
    
    for (var city in cityCountryMap) {
      if (lower.indexOf(city) !== -1) {
        return cityCountryMap[city];
      }
    }
    
    return '';
  }

  function getFlagForInstitution(name) {
    var code = getCountryCodeFromName(name);
    return code ? countryCodeToFlagHtml(code) : '';
  }

  function buildGeoFilterOptions() {
    var select = document.getElementById('geoFilter');
    var previous = geoFilter;
    var countries = {};
    var continents = {};

    allData.forEach(function(inst) {
      var code = getCountryCodeFromName(inst.affiliation || '');
      if (!code) return;
      countries[code] = true;
      var continent = codeToContinent[code] || 'Unknown';
      continents[continent] = true;
    });

    var continentList = Object.keys(continents)
      .filter(function(c) { return c !== 'Unknown'; })
      .sort();

    var countryList = Object.keys(countries).sort(function(a, b) {
      var an = codeToName[a] || a;
      var bn = codeToName[b] || b;
      return an.localeCompare(bn);
    });

    var options = [{ value: 'world', label: 'World' }];
    continentList.forEach(function(continent) {
      options.push({ value: 'continent:' + continent, label: continent });
    });
    countryList.forEach(function(code) {
      options.push({ value: 'country:' + code, label: codeToName[code] || code });
    });

    select.innerHTML = options.map(function(option) {
      return '<option value="' + option.value + '">' + escHtml(option.label) + '</option>';
    }).join('');

    var hasPrevious = options.some(function(option) { return option.value === previous; });
    geoFilter = hasPrevious ? previous : 'world';
    select.value = geoFilter;
  }

  function applySearch() {
    var lower = searchFilter.toLowerCase();
    filteredData = allData.filter(function(inst) {
      var aff = (inst.affiliation || '');
      var affLower = aff.toLowerCase();
      if (lower && affLower.indexOf(lower) === -1) return false;

      if (geoFilter === 'world') return true;

      var code = getCountryCodeFromName(aff);
      if (!code) return false;

      if (geoFilter.indexOf('continent:') === 0) {
        var continent = geoFilter.slice('continent:'.length);
        return (codeToContinent[code] || 'Unknown') === continent;
      }

      if (geoFilter.indexOf('country:') === 0) {
        return code === geoFilter.slice('country:'.length);
      }

      return true;
    });
    sortData(sortCol, sortAsc);
    currentPage = 0;
  }

  function render() {
    var start = pageSize > 0 ? currentPage * pageSize : 0;
    var end = pageSize > 0 ? start + pageSize : sortedData.length;
    var page = sortedData.slice(start, end);

    var tbody = document.getElementById('institutionBody');
    var rows = [];
    var numCols = fixedCols.length + yearColumns.length;
    
    for (var i = 0; i < page.length; i++) {
      var inst = page[i];
      var instId = 'inst-' + (start + i);
      var isExpanded = expandedRows.has(instId);
      var cells = [];
      
      // Rank column with expand button
      var expandIcon = inst.top_authors && inst.top_authors.length > 0 
        ? '<span class="expand-btn" style="cursor:pointer;margin-right:4px;">' + (isExpanded ? '▼' : '▶') + '</span>'
        : '<span style="margin-right:12px;"></span>';
      cells.push('<td>' + expandIcon + (start + i + 1) + '</td>');
      
      var aff = (inst.affiliation || 'Unknown').replace(/^_/, '');
      var flag = getFlagForInstitution(aff);
      cells.push('<td>' + (flag || '') + escHtml(aff) + '</td>');
      cells.push('<td><strong>' + inst.combined_score + '</strong></td>');
      cells.push('<td>' + (inst.num_authors || '') + '</td>');
      cells.push('<td>' + (inst.artifacts || '') + '</td>');
      cells.push('<td>' + (inst.total_papers || '') + '</td>');
      cells.push('<td>' + (inst.total_papers > 0 ? inst.artifact_rate + '%' : '') + '</td>');
      // Calculate repro rate from badges
      var reproRate = 0;
      if (inst.badges_functional > 0 || inst.badges_reproducible > 0) {
        var total_badges = (inst.badges_functional || 0) + (inst.badges_reproducible || 0);
        if (total_badges > 0) {
          reproRate = Math.round((inst.badges_reproducible / total_badges) * 100);
        }
      }
      cells.push('<td>' + (reproRate > 0 ? reproRate : '') + '</td>');
      cells.push('<td>' + (inst.ae_memberships || '') + '</td>');
      var chairLabel = inst.chair_count > 0 ? inst.chair_count + ' ★' : '';
      cells.push('<td>' + chairLabel + '</td>');
      for (var j = 0; j < yearColumns.length; j++) {
        var yr = yearColumns[j];
        var cnt = 0;
        if (inst.years) {
          cnt = inst.years[yr] || inst.years[String(yr)] || 0;
        }
        cells.push('<td>' + (cnt > 0 ? cnt : '') + '</td>');
      }
      
      rows.push('<tr class="inst-row" data-inst-id="' + instId + '" style="cursor:pointer;">' + cells.join('') + '</tr>');
      
      // Add expanded row if needed
      if (isExpanded && inst.top_authors && inst.top_authors.length > 0) {
        var expandedContent = '<td colspan="' + numCols + '" style="padding:8px 16px; background-color:#f9f9f9;">';
        expandedContent += '<div style="margin-left:20px;"><strong>Top ' + inst.top_authors.length + ' Researchers:</strong><br>';
        expandedContent += '<table style="margin-top:8px; font-size:0.9em; border-collapse:collapse; width:auto;">';
        expandedContent += '<thead><tr style="background-color:#e8e8e8;"><th style="padding:4px 8px;border:1px solid #ccc;">Name</th><th style="padding:4px 8px;border:1px solid #ccc;">Combined</th><th style="padding:4px 8px;border:1px solid #ccc;">Artifacts</th><th style="padding:4px 8px;border:1px solid #ccc;">AE Service</th><th style="padding:4px 8px;border:1px solid #ccc;">Papers</th></tr></thead><tbody>';
        
        for (var k = 0; k < inst.top_authors.length; k++) {
          var author = inst.top_authors[k];
          var displayName = author.name.replace(/\s+\d{4}$/, '').replace(/\t/g, ' ');
          var profileUrl = baseUrl + '/author.html?name=' + encodeURIComponent(author.name);
          expandedContent += '<tr style="' + (k % 2 === 0 ? 'background-color:#fff;' : 'background-color:#f5f5f5;') + '">';
          expandedContent += '<td style="padding:4px 8px;border:1px solid #ccc;"><a href="' + profileUrl + '">' + escHtml(displayName) + '</a></td>';
          expandedContent += '<td style="padding:4px 8px;border:1px solid #ccc;text-align:center;"><strong>' + author.combined_score + '</strong></td>';
          expandedContent += '<td style="padding:4px 8px;border:1px solid #ccc;text-align:center;">' + (author.artifacts || 0) + '</td>';
          expandedContent += '<td style="padding:4px 8px;border:1px solid #ccc;text-align:center;">' + (author.ae_memberships || 0) + '</td>';
          expandedContent += '<td style="padding:4px 8px;border:1px solid #ccc;text-align:center;">' + (author.total_papers || 0) + '</td>';
          expandedContent += '</tr>';
        }
        
        expandedContent += '</tbody></table></div></td>';
        rows.push('<tr class="expanded-row" data-inst-id="' + instId + '">' + expandedContent + '</tr>');
      }
    }
    tbody.innerHTML = rows.join('');
    
    // Add click handlers for expand/collapse
    var instRows = document.querySelectorAll('.inst-row');
    instRows.forEach(function(row) {
      row.addEventListener('click', function(e) {
        var instId = row.dataset.instId;
        if (expandedRows.has(instId)) {
          expandedRows.delete(instId);
        } else {
          expandedRows.add(instId);
        }
        render();
      });
    });
    
    updatePageInfo();
  }

  function escHtml(s) {
    var d = document.createElement('div');
    d.appendChild(document.createTextNode(s));
    return d.innerHTML;
  }

  function sortData(colIdx, asc) {
    sortedData = filteredData.slice();
    var key;
    if (colIdx < fixedCols.length) {
      key = fixedCols[colIdx].key;
    } else {
      var yIdx = colIdx - fixedCols.length;
      var yr = yearColumns[yIdx];
      key = '_y' + yr;
    }
    sortedData.sort(function(a, b) {
      var av, bv;
      if (key.startsWith('_y')) {
        var y = key.slice(2);
        av = (a.years || {})[y] || (a.years || {})[parseInt(y)] || 0;
        bv = (b.years || {})[y] || (b.years || {})[parseInt(y)] || 0;
      } else if (key === 'affiliation') {
        av = (a[key] || '').toLowerCase();
        bv = (b[key] || '').toLowerCase();
      } else if (key === 'num_conferences') {
        av = a.conferences ? a.conferences.length : 0;
        bv = b.conferences ? b.conferences.length : 0;
      } else {
        av = a[key] || 0;
        bv = b[key] || 0;
      }
      if (av < bv) return asc ? -1 : 1;
      if (av > bv) return asc ? 1 : -1;
      return 0;
    });
  }

  function updatePageInfo() {
    var total = sortedData.length;
    var start = pageSize > 0 ? currentPage * pageSize : 0;
    var end = pageSize > 0 ? Math.min(start + pageSize, total) : total;
    var pages = pageSize > 0 ? Math.ceil(total / pageSize) : 1;
    var info = (start+1) + '–' + end + ' of ' + total;
    document.getElementById('iPageInfoB').textContent = info;
    document.getElementById('iTotalInfo').textContent = total + ' institutions total';
    var atFirst = currentPage <= 0;
    var atLast = pageSize <= 0 || currentPage >= pages - 1;
    document.getElementById('iPrevBtnB').disabled = atFirst;
    document.getElementById('iNextBtnB').disabled = atLast;
  }

  function shortenYear(yr) {
    return '' + yr % 100;
  }

  function buildHeader() {
    var tr = document.getElementById('institutionHead');
    tr.innerHTML = '';
    var allCols = fixedCols.slice();
    for (var i = 0; i < yearColumns.length; i++) {
      allCols.push({label: shortenYear(yearColumns[i]), key:'_y' + yearColumns[i], type:'num'});
    }
    for (var ci = 0; ci < allCols.length; ci++) {
      var th = document.createElement('th');
      th.innerHTML = allCols[ci].label;
      th.className = 'i-sortable';
      th.dataset.colIdx = ci;
      th.style.cursor = 'pointer';
      if (ci === sortCol) th.classList.add(sortAsc ? 'i-sorted-asc' : 'i-sorted-desc');
      th.addEventListener('click', (function(idx) {
        return function(e) {
          if (sortCol === idx) { sortAsc = !sortAsc; }
          else { sortCol = idx; sortAsc = false; }
          sortData(sortCol, sortAsc);
          currentPage = 0;
          render();
          var ths = document.getElementById('institutionHead').querySelectorAll('.i-sortable');
          ths.forEach(function(h) { h.classList.remove('i-sorted-asc','i-sorted-desc'); });
          e.currentTarget.classList.add(sortAsc ? 'i-sorted-asc' : 'i-sorted-desc');
        };
      })(ci));
      tr.appendChild(th);
    }
  }

  function init(data) {
    // Filter out institutions with Unknown affiliation
    allData = data.filter(function(inst) {
      var aff = (inst.affiliation || '').toLowerCase();
      return aff && aff !== 'unknown' && !aff.startsWith('_unknown');
    });
    buildGeoFilterOptions();
    applySearch();
    
    // Extract year columns
    var yrs = {};
    for (var i = 0; i < allData.length; i++) {
      if (allData[i].years) {
        for (var y in data[i].years) {
          yrs[y] = true;
        }
      }
    }
    yearColumns = Object.keys(yrs).map(function(y){ return parseInt(y) || y; })
      .sort(function(a,b){return b-a;});

    buildHeader();
    sortData(sortCol, sortAsc);
    render();

    document.getElementById('institutionLoading').style.display = 'none';
    document.getElementById('institutionTable').style.display = '';
    document.getElementById('institution-controls').style.display = '';
    document.getElementById('institution-legend').style.display = '';
    document.getElementById('institution-controls-bottom').style.display = '';
  }

  function loadArea(area) {
    currentArea = area;
    expandedRows.clear(); // Clear expanded state when switching areas
    document.getElementById('institutionLoading').style.display = '';
    document.getElementById('institutionLoading').innerHTML = '<em>Loading ' + area + ' institution ranking data…</em>';
    document.getElementById('institutionTable').style.display = 'none';
    document.getElementById('institution-controls').style.display = 'none';
    document.getElementById('institution-legend').style.display = 'none';
    document.getElementById('institution-controls-bottom').style.display = 'none';
    
    fetch(DATA_URLS[area])
      .then(function(r) { return r.json(); })
      .then(init)
      .catch(function(e) {
        document.getElementById('institutionLoading').innerHTML =
          '<em>Failed to load ' + area + ' institution ranking data. ' + e + '</em>';
      });
  }

  // Area filter
  document.getElementById('areaFilter').addEventListener('change', function() {
    loadArea(this.value);
  });

  // Search filter
  document.getElementById('affiliationSearch').addEventListener('input', function() {
    searchFilter = this.value;
    applySearch();
    render();
  });

  // Geographic filter
  document.getElementById('geoFilter').addEventListener('change', function() {
    geoFilter = this.value;
    applySearch();
    render();
  });

  // Controls
  function goPrev() { if (currentPage > 0) { currentPage--; render(); } }
  function goNext() {
    var pages = pageSize > 0 ? Math.ceil(sortedData.length / pageSize) : 1;
    if (currentPage < pages - 1) { currentPage++; render(); }
  }
  document.getElementById('iPrevBtnB').addEventListener('click', goPrev);
  document.getElementById('iNextBtnB').addEventListener('click', goNext);

  // Load initial data
  loadArea(currentArea);
})();
</script>

<style>
#institutionTable { font-size: 0.78em; border-collapse: collapse; width: 100%; }
#institutionTable th, #institutionTable td { padding: 2px 4px; border: 1px solid #ddd; }
#institutionTable th:nth-child(2), #institutionTable td:nth-child(2) { max-width: 200px; word-wrap: break-word; white-space: normal; }
#institutionTable td { white-space: nowrap; }
#institutionTable th { background-color: #f2f2f2; position: sticky; top: 0; z-index: 1; }
#institutionTable tr:nth-child(even) { background-color: #f9f9f9; }
#institutionTable .inst-row:hover { background-color: #e8f4f8; }
#institutionTable .expanded-row { background-color: #f9f9f9 !important; }
#institutionTable .expanded-row:hover { background-color: #f9f9f9 !important; }
.i-sortable::after { content: '\2195'; opacity: 0.3; margin-left: 2px; font-size: 0.75em; }
.i-sorted-asc::after { content: '\2191'; opacity: 1; }
.i-sorted-desc::after { content: '\2193'; opacity: 1; }
.expand-btn { display: inline-block; font-size: 0.8em; color: #666; }
.expand-btn:hover { color: #000; }
/* Flag icons styling */
.fi { width: 1em; height: 1em; display: inline-block; margin-right: 4px; vertical-align: -0.125em; }
</style>
